<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <title>Project</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; }
    .error { color: #b00020; margin-top: .5rem; }
    .row { margin-bottom: 1rem; }
    form { display: inline-block; margin-right: .75rem; }
    input[type="text"] { padding: .4rem .6rem; font-size: 1rem; }
    button { padding: .45rem .8rem; font-size: 1rem; cursor: pointer; }
    .muted { color: #555; }
  </style>
</head>
<body>
  {% if project_name %}
    <p class="row">
      <strong>Aktuellt projekt:</strong>
      <span class="muted">{{ project_name }}</span>
    </p>
  {% endif %}

  <!-- Ett och samma formulär som byter metod (POST/PUT) i JS beroende på state -->
  <form id="projectForm">
    <label for="project_name">Projektnamn:</label>
    <input id="project_name" name="project_name" type="text" placeholder="Ange projektnamn"
           value="{{ project_name or '' }}">
    <button type="submit">
      {% if project_name %}Byt namn (PUT){% else %}Skapa (POST){% endif %}
    </button>
  </form>

  {% if project_name %}
    <!-- Delete visas bara om ett projekt finns -->
    <form id="deleteForm">
      <button type="submit" onclick="return confirm('Radera aktuellt projekt?');">Radera projekt (DELETE)</button>
    </form>
  {% endif %}

  {% if error %}
    <div class="error">{{ error }}</div>
  {% endif %}

  <script>
    // Sätt vilket anrop som ska göras: POST om inget projekt, PUT om projekt finns.
    const hasProject = {{ 'true' if project_name else 'false' }};

    document.getElementById("projectForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("project_name").value.trim();
      if (!name) { alert("Project name must be non-empty."); return; }

      const method = hasProject ? "PUT" : "POST";
      const res = await fetch("/api/project", {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ project_name: name })
      });

      if (res.ok) {
        location.reload();
      } else {
        let msg = `${res.status} ${res.statusText}`;
        try { const j = await res.json(); msg = j.error || msg; } catch {}
        alert(msg);
      }
    });

    const deleteForm = document.getElementById("deleteForm");
    if (deleteForm) {
      deleteForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const res = await fetch("/api/project", { method: "DELETE" });
        if (res.status === 204) {
          location.reload();
        } else {
          alert("Fel vid borttagning.");
        }
      });
    }
  </script>
</body>
</html>